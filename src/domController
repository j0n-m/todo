import pubSub from "./pubSub";
import { format, formatDistance, formatRelative, parse, parseISO } from 'date-fns'

const domController = (function () {
  let allProjects = [];
  let activeProject;
  // DOM selectors
  const contentContainer = document.querySelector('.content');
  const projectList = document.querySelector('.project-list');
  const projectAddForm = document.querySelector('#project-add-form')
  const newProjectBtn = document.querySelector('.new-project-btn');
  const formContainer = document.querySelector('.form-field');
  const formCancelBtn = document.querySelector('#project-cancel-btn');
  const formTextbox = document.querySelector('#project-title-textbox');
  const errorMsg = document.querySelector('.error-msg');
  const addTaskOverlay = document.querySelector('.addTaskOverlay');
  const closeTaskOverlayBtn = document.querySelector('#closeTaskContainerBtn');
  const addTaskForm = document.querySelector('#addTaskForm');

  //manual event listener for dynamically created elements
  document.addEventListener('click', function (e) {
    let addTaskBtn = e.target.closest('#addTaskBtn');
    let projectBtn = e.target.closest('.project-btn');

    if (addTaskBtn) {
      console.log(getActiveProjectIndex(activeProject))
      toggleAddTaskOverlay();
    }
    if (projectBtn) {
      console.log(projectBtn)
      changeMainContent(e);
    }
  })

  // Event Handlers
  projectAddForm.addEventListener('submit', projectAdd);
  newProjectBtn.addEventListener('click', toggleProjectAddForm);
  formCancelBtn.addEventListener('click', toggleProjectAddForm);
  closeTaskOverlayBtn.addEventListener('click', toggleAddTaskOverlay)
  addTaskForm.addEventListener('submit', VerifyAddingTask);


  //Pubsub
  pubSub.subscribe('addToProjectList', addToProjectList);
  pubSub.subscribe('error-duplicate', displayError)
  pubSub.subscribe('newTask', showTasks);
  pubSub.subscribe('loadHomePage', loadContent);
  pubSub.subscribe('overwriteProjectListing', overwriteAllProjects);

  // Event Functions
  function projectAdd(e) {
    e.preventDefault();
    pubSub.publish('addNewProject', { title: formTextbox.value });
    toggleProjectAddForm();
  }
  function overwriteAllProjects(projectsArr) {
    allProjects = [];
    for (let i = 0; i < projectsArr.length; i++) {
      allProjects.push(projectsArr[i]);
    }
    console.log('overwrite completed')
  }
  function toggleProjectAddForm() {
    formTextbox.value = '';
    formContainer.classList.toggle('hide');
  }
  function toggleAddTaskOverlay() {
    addTaskForm.reset();
    addTaskOverlay.classList.toggle('hide');
  }
  function showTasks() {
    loadContent(getActiveProjectIndex(activeProject));
  }
  function VerifyAddingTask(e) {
    e.preventDefault();
    const taskTitle = document.querySelector('#taskName').value;
    const taskDesc = document.querySelector('#descriptionBox').value;
    let taskDueDate = document.querySelector('#dueDate').value;
    const taskPriority = document.querySelector('#priority').value;
    const activeProjectIndex = getActiveProjectIndex(activeProject);

    const date = new Date(taskDueDate.replace(/-/g, '/'))
    taskDueDate = format(new Date(date), 'MMMM/dd/yyyy');


    addTaskToProject({ title: taskTitle, desc: taskDesc, dueDate: taskDueDate, priority: taskPriority }, activeProjectIndex);
    toggleAddTaskOverlay();


  }
  function addTaskToProject({ title, desc, dueDate, priority }, projectIndex) {
    // allProjects[projectIndex].tasks.push({ title, desc, dueDate, priority });
    allProjects[projectIndex].addTask({ title, desc, dueDate, priority });
    console.log('allProjects', allProjects);
    //add task to project[projectIndex]->modifies the todo.projects;
    //'publish' the modifiedarray to todoController.editproject
    //replaces old array with the new
    //delete the LS array and send this one
    //done



  }
  function addToProjectList(projObj) {
    const projectTitle = projObj.title;
    const projectBtn = document.createElement('div');
    projectBtn.classList.add('btn');
    projectBtn.classList.add('project-btn');
    projectBtn.dataset.projectname = projectTitle;
    projectBtn.textContent = projectTitle;
    console.log('added to projectList:, ', projObj.title);

    projectList.appendChild(projectBtn);
    allProjects.push(projObj);
  }
  function displayError(msg) {
    errorMsg.textContent = msg;

    setTimeout(function () {
      errorMsg.textContent = '';
    }, 4000)
  }
  function loadContent(index) {
    let currentProject = allProjects[index];
    activeProject = currentProject.getTitle();
    contentContainer.replaceChildren();
    if (!currentProject.tasks.length) {
      const noTaskPara = document.createElement('p')
      noTaskPara.textContent = 'No tasks :('
      contentContainer.appendChild(noTaskPara);

    }
    displayContent(currentProject.tasks);
  }
  function displayContent(taskArr) {

    const taskContent = document.createElement('div');
    taskContent.classList.add('taskContent');

    const addTaskBtn = document.createElement('div')
    addTaskBtn.classList.add('btn')
    addTaskBtn.id = 'addTaskBtn';
    addTaskBtn.classList.add('addTaskBtn');
    addTaskBtn.dataset.projectindex = getActiveProjectIndex(activeProject);
    addTaskBtn.textContent = "Add a Task"

    taskContent.appendChild(addTaskBtn);
    contentContainer.appendChild(taskContent);

    taskArr.forEach(task => {
      const colorTile = document.createElement('div');
      colorTile.classList.add('color-tile');

      const mainTile = document.createElement('div');
      mainTile.classList.add('main-tile');

      const pTitle = document.createElement('h1')
      pTitle.textContent = task.getTitle();

      mainTile.appendChild(pTitle);
      colorTile.appendChild(mainTile);
      contentContainer.appendChild(colorTile);
    })
  }

  function changeMainContent(e) {
    activeProject = e.target.dataset.projectname;
    let activeProjectIndex = getActiveProjectIndex(activeProject);

    loadContent(activeProjectIndex);
  }
  function getActiveProjectIndex(title) {
    let index;
    allProjects.forEach((project, projIndex) => {
      if (project.getTitle() === title) {
        index = projIndex;
      }
    });
    return index;
  }
  return { changeMainContent };

})();

export default domController;